services:
  app:
    container_name: consultancy_pricing_app_prod
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=production
      # CORS: specify allowed origins (comma-separated)
      - CORS_ORIGINS=${CORS_ORIGINS}
      # External PostgreSQL connection (Cloud SQL, RDS, Azure Database, etc.)
      # Format examples:
      #   Cloud SQL (private IP): INSTANCE_CONNECTION_NAME=10.x.x.x:5432
      #   Cloud SQL (Cloud SQL Proxy): INSTANCE_CONNECTION_NAME=/cloudsql/project:region:instance
      #   AWS RDS: INSTANCE_CONNECTION_NAME=mydb.xyz.region.rds.amazonaws.com:5432
      #   Azure Database: INSTANCE_CONNECTION_NAME=myserver.postgres.database.azure.com:5432
      - INSTANCE_CONNECTION_NAME=${INSTANCE_CONNECTION_NAME}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME:-consultancy_pricing}
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

# Production uses Supabase as managed PostgreSQL database
#
# Supabase setup checklist:
# 1. Create a project at https://supabase.com
# 2. Go to Project Settings > Database
# 3. Find the connection info under "Connection string" > "URI"
# 4. Set environment variables in .env file:
#    - INSTANCE_CONNECTION_NAME: db.<your-project>.supabase.co:5432
#    - DB_USER: postgres
#    - DB_PASS: your database password (from project settings)
#    - DB_NAME: postgres (default Supabase database)
#    - CORS_ORIGINS: your production domain(s)
# 5. The connection uses SSL by default (Supabase requirement)
# 6. Database migrations will run automatically on container startup
